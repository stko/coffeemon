
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta id="viewport" content="width=device-width, initial-scale=1">

<title>CoffeeMon</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script>
var wsURL=getParameterByName('wsurl');
var infoWindow = null;
var lastRecvStatus="normal"

  $( function() {
	var x = document.getElementsByClassName("cb"); // load the notification settings
	var i;
	for (i = 0; i < x.length; i++) {
		var cb=x[i];
		if (localStorage && cb.id in localStorage) {
			cb.checked = localStorage[cb.id]=='true';
		}
  	}
     	if (wsURL==null || wsURL==""){
	//split a whole URL: var full = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
		wsURL = 'ws://'+location.hostname+ ':9000';
	}
	$("#keytext").val( "")
	if (localStorage && 'keytext' in localStorage) {
		$("#keytext").val( localStorage.keytext);
	}
	$("#inputtext").val( "")
	$("#connectButton").prop("disabled",$("#keytext").val().length<4);
	$("#disconnectButton").prop("disabled", true);
	$("#echoButton").prop("disabled", true);
 	$("#inputtext").prop("disabled", true);
 	doConnect();
 	window.onbeforeunload = function(e) {
		var dialogText = 'Dialog text here';
		e.returnValue = dialogText;
		if(infoWindow){
			infoWindow.close();
		}
		//return dialogText;
		return null; // avoids "ok to close?" message
		};
	$( "#accordion" ).accordion({
		collapsible: true,
		active: false,
		heightStyle: "content"
	});
	$( ".controlgroup-vertical" ).controlgroup({
		"direction": "vertical"
	});
	$( "document" ).tooltip();

  } );
	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));

		}
  
  function handleClick(cb){
	localStorage && (localStorage[cb.id] = cb.checked);
  }

  function doConnect()
  {
    //websocket = new WebSocket($("#url").val());
    websocket = new WebSocket(wsURL);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
	//doSend(JSON.stringify({msg:  btoa($("#keytext").val()+ " enters the coffee kitchen"), channel: btoa($("#keytext").val())})  );
 	doSend(JSON.stringify({ channel: btoa($("#keytext").val())})  ); //tells the server the own channel name, needed for the entering message generated by the server
        localStorage && (localStorage.keytext = $("#keytext").val());

	writeToScreen("connected\n");
	$("#keytext").prop("disabled", true);
	$("#connectButton").prop("disabled", true);
	$("#disconnectButton").prop("disabled", false);
	$("#echoButton").prop("disabled", false);
 	$("#inputtext").prop("disabled", false);
 	
  }

  function onClose(evt)
  {
	writeToScreen("disconnected\n");
	$("#keytext").prop("disabled", false);
	$("#connectButton").prop("disabled", false);
	$("#disconnectButton").prop("disabled", true);
	$("#echoButton").prop("disabled", true);
 	$("#inputtext").prop("disabled", true);
   }

  function onMessage(evt)
  {
	try {
		obj = JSON.parse(evt.data);

		arrivingTime=Date.now();
		if (obj.value){
			writeToScreen(obj.value+"\n");
		}
		if (obj.state){
			var x = document.getElementById(obj.state);
			if (x){ // simple: name the icons like the checkboxes like the states itself. Saves much work :-)
				if (infoWindow){
					infoWindow.document.getElementById("swap").src = obj.state+".png";
				}
				if (x.checked){ 
					notifyMe(obj.state+".png",atob(obj.msg));
				}
			}
		}else{
			if (obj.msg){
				writeToScreen(atob(obj.msg));
				if(document.getElementById("write").checked){ 
					notifyMe("write.png","something new in the chat");
				}

			}
		}
	}
	catch(err){
		console.log("Json Error "+err.message);
	}
  }

  function onError(evt)
  {
    writeToScreen('error: ' + evt.data + '\n');

	websocket.close();

	$("#keytext").prop("disabled", false);
	$("#connectButton").prop("disabled", false);
	$("#disconnectButton").prop("disabled", true);
	$("#echoButton").prop("disabled", true);
 	$("#inputtext").prop("disabled", true);

  }

  function doSend(message)
  {
    websocket.send(message+ '\n');
  }

  function writeToScreen(message)
  {
    $("#outputtext").val($("#outputtext").val() + message);
	$("#outputtext").prop("scrollTop", $("#outputtext").prop("scrollHeight"));

  }

  //window.addEventListener("load", init, false);


   function sendText() {
		var msg=JSON.stringify({msg: btoa($("#inputtext").val()+"\r"), channel: btoa($("#keytext").val())}); 
		doSend(msg  );
		writeToScreen($("#keytext").val()+": "+ $("#inputtext").val()+"\n");
   }

  function doEcho() {
		var msg=JSON.stringify({value: "", channel: btoa($("#keytext").val())}); 
		doSend(msg  );
   }

  function doState() {
		var msg=JSON.stringify({state: "", channel: btoa($("#keytext").val())}); 
		doSend(msg  );
   }

  function clearText() {
		$("#outputtext").val( "");
   }

   function doDisconnect() {
		websocket.close();
   }


	function openInfo() {
		infoWindow= window.open('info.html', 'infowindow','toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=130,height=135');
		if (infoWindow) doState();
	}
   
	// request permission on page load
	document.addEventListener('DOMContentLoaded', function () {
		if (!Notification) {
			alert('Desktop notifications not available in your browser. Try Chromium.'); 
			return;
		}

		if (Notification.permission !== "granted")
			Notification.requestPermission();
	});

	function notifyMe(icon, message) {
		if (Notification.permission !== "granted")
			Notification.requestPermission();
		else {
			if (icon){
				var notification = new Notification('Coffemon says:', {
					icon: icon,
					body: message,
				});
			}else{
				var notification = new Notification('Coffemon says:', {
					body: message,
				});
			}

			
			//notification.onclick = function () {
			//window.open("http://stackoverflow.com/a/13328397/1269037");      
			//};
		}
		
	}


</script>

</head>
<body>
<div class="widget">
	<div class="ui-widget ui-corner-all" >
		<h2>CoffeeMon - the Coffee Pot Status Monitor</h2>
		<p>
		Want to know the filling level of the office coffee pot?? Just connect to the Coffee Pot Status Monitor and be informed!
		</p>
		<h3>Messages</h3>
		<p>
	</div>
	<div id="control">
	<textarea  class="ui-widget ui-corner-all" id="outputtext" rows="20" cols="50"></textarea>
	</p>
		<label  class="ui-widget ui-corner-all" for="inputtext">send text</label>
		<input id="inputtext" class="ui-button ui-widget ui-corner-all" type="text" size="30" maxlength="30" onkeyup="if (event.keyCode == 13) { sendText(); return false; }" title="Write something to the other users">
		<input type="button" class="ui-button ui-widget ui-corner-all" id="clearButton" value="Clear" onClick="clearText();">
		<input type="button" class="ui-button ui-widget ui-corner-all" id="InfoWin" value="Open Monitor" onClick="openInfo();">
	</div>
	<div id="accordion">
		<h3>Settings</h3>
		<div>
			<label for="keytext">Chat nickname (min. 4 chars)</label><input id="keytext" type="text" value="aa" size="30" maxlength="140" onkeyup="$('#connectButton').prop('disabled',this.value.length<4)" title="Thats the senders name appearing in the chat window">
			<input type="button" id="connectButton" value="Connect" onClick="doConnect();">
			<input type="button" id="disconnectButton" value="Disconnect" onClick="doDisconnect();">
			<input type="button" id="echoButton" value="Read actual weight value" onClick="doEcho();">
			<fieldset>
				<legend>Notifications</legend>
				<div class="controlgroup-vertical">
					<input type="checkbox" id="full" class="cb" onclick='handleClick(this);'><label for="full"> Full Pot</label>
					<input type="checkbox" id="normal" class="cb" onclick='handleClick(this);'><label for="normal"> Normal Pot</label>
					<input type="checkbox" id="empty" class="cb" onclick='handleClick(this);'><label for="empty"> Empty Pot</label>
					<input type="checkbox" id="nopot" class="cb" onclick='handleClick(this);'><label for="nopot"> No Pot</label>
					<input type="checkbox" id="join" class="cb" onclick='handleClick(this);'><label for="join"> Somebody joins the chat</label>
					<input type="checkbox" id="leave" class="cb" onclick='handleClick(this);'><label for="leave"> Somebody leaves the chat</label>
					<input type="checkbox" id="write" class="cb" onclick='handleClick(this);'><label for="write"> Somebody writes</label>
				</div>
			</fieldset>
		</div>

		<h3>Credits</h3>
		<div>
			The chat icons are
			<a href='https://www.freepik.com/free-vector/social-media-flat-icon-set_841696.htm'>Designed by Freepik</a>
			<br>
			The original Coffee Maker symbol is <a href='https://thenounproject.com/inspign/'>(cc) by Aaron K. Kim from the Noun Project</a>
			<br>Coffeemon itself is Open Source and <a href='https://github.com/stko/coffeemon'>hosted on Github<img src='GitHub-Mark-32px.png'></a>
		</div>
	</div>
</div>
</body>
</html> 


