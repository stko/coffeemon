
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<title>CoffeeMon</title>

<script language="javascript" type="text/javascript">

	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));

		}
var wsURL=getParameterByName('wsurl');
var infoWindow = null;
var lastRecvStatus="normal"

  function init()
  {
	if (wsURL==null || wsURL=""){
	//split a whole URL: var full = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
		wsURL = 'ws://'+location.hostname+ ':9000';
	}
	document.myform.keytext.value = ""
	if (localStorage && 'keytext' in localStorage) {
		document.myform.keytext.value = localStorage.keytext;
	}
	var x = document.getElementsByClassName("cb"); // load the notification settings
	var i;
	for (i = 0; i < x.length; i++) {
		var cb=x[i];
		if (localStorage && cb.id in localStorage) {
			cb.checked = localStorage[cb.id]=='true';
		}
  	}
	document.myform.inputtext.value = ""
	document.myform.connectButton.disabled=document.myform.keytext.value.length<4
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;
 	doConnect();
 	window.onbeforeunload = function(e) {
		var dialogText = 'Dialog text here';
		e.returnValue = dialogText;
		if(infoWindow){
			infoWindow.close();
		}
		//return dialogText;
		return null; // avoids "ok to close?" message
		};
  }
  
  function handleClick(cb){
	localStorage && (localStorage[cb.id] = cb.checked);
  }

  function doConnect()
  {
    //websocket = new WebSocket(document.myform.url.value);
    websocket = new WebSocket(wsURL);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
	//doSend(JSON.stringify({msg:  btoa(document.myform.keytext.value+ " enters the coffee kitchen"), channel: btoa(document.myform.keytext.value)})  );
 	doSend(JSON.stringify({ channel: btoa(document.myform.keytext.value)})  ); //tells the server the own channel name, needed for the entering message generated by the server
        localStorage && (localStorage.keytext = document.myform.keytext.value);

	writeToScreen("connected\n");
	document.myform.keytext.disabled = true;
	document.myform.connectButton.disabled = true;
	document.myform.disconnectButton.disabled = false;
	document.myform.echoButton.disabled = false;
 	document.myform.inputtext.disabled = false;
 	
  }

  function onClose(evt)
  {
	writeToScreen("disconnected\n");
	document.myform.keytext.disabled = false;
	document.myform.connectButton.disabled = false;
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;
   }

  function onMessage(evt)
  {
	try {
		obj = JSON.parse(evt.data);

		arrivingTime=Date.now();
		if (obj.value){
			writeToScreen(obj.value+"\n");
		}
		if (obj.state){
			var x = document.getElementById(obj.state);
			if (x){ // simple: name the icons like the checkboxes like the states itself. Saves much work :-)
				if (infoWindow){
					infoWindow.document.getElementById("swap").src = obj.state+".png";
				}
				if (x.checked){ 
					notifyMe(obj.state+".png",atob(obj.msg));
				}
			}
		}else{
			if (obj.msg){
				writeToScreen(atob(obj.msg));
				if(document.getElementById("write").checked){ 
					notifyMe("write.png","something new in the chat");
				}

			}
		}
	}
	catch(err){
		console.log("Json Error "+err.message);
	}
  }

  function onError(evt)
  {
    writeToScreen('error: ' + evt.data + '\n');

	websocket.close();

	document.myform.keytext.disabled = false;
	document.myform.connectButton.disabled = false;
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;

  }

  function doSend(message)
  {
    websocket.send(message+ '\n');
  }

  function writeToScreen(message)
  {
    document.myform.outputtext.value += message
	document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;

  }

  window.addEventListener("load", init, false);


   function sendText() {
		var msg=JSON.stringify({msg: btoa(document.myform.inputtext.value+"\r"), channel: btoa(document.myform.keytext.value)}); 
		doSend(msg  );
		writeToScreen(document.myform.keytext.value+": "+ document.myform.inputtext.value+"\n");
   }

  function doEcho() {
		var msg=JSON.stringify({value: "", channel: btoa(document.myform.keytext.value)}); 
		doSend(msg  );
   }

  function doState() {
		var msg=JSON.stringify({state: "", channel: btoa(document.myform.keytext.value)}); 
		doSend(msg  );
   }

  function clearText() {
		document.myform.outputtext.value = "";
   }

   function doDisconnect() {
		websocket.close();
   }


	function openInfo() {
		infoWindow= window.open('info.html', 'infowindow','toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=130,height=135');
		if (infoWindow) doState();
	}
   
	// request permission on page load
	document.addEventListener('DOMContentLoaded', function () {
		if (!Notification) {
			alert('Desktop notifications not available in your browser. Try Chromium.'); 
			return;
		}

		if (Notification.permission !== "granted")
			Notification.requestPermission();
	});

	function notifyMe(icon, message) {
		if (Notification.permission !== "granted")
			Notification.requestPermission();
		else {
			if (icon){
				var notification = new Notification('Coffemon says:', {
					icon: icon,
					body: message,
				});
			}else{
				var notification = new Notification('Coffemon says:', {
					body: message,
				});
			}

			
			//notification.onclick = function () {
			//window.open("http://stackoverflow.com/a/13328397/1269037");      
			//};
		}
		
	}


</script>

</head>
<body>
<h2>CoffeeMon - the Coffee Pot Status Monitor</h2>
<p>
Want to know the filling level of the office coffee pot?? Just connect to the Coffee Pot Status Monitor and be informed!
</p>
<form name="myform">
Chat nickname (min. 4 chars): <input name="keytext" type="text" value="aa" size="30" maxlength="140" onkeyup="document.myform.connectButton.disabled=this.value.length<4">
<br/>

<!--
<input type="button" name=sendButton value="Send" onClick="sendText();">
-->
<input type="button" name=connectButton value="Connect" onClick="doConnect();">
<input type="button" name=clearButton value="Clear" onClick="clearText();">
<input type="button" name=echoButton value="Read actual weight value" onClick="doEcho();">
<input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
<input type="button" name=InfoWin value="Open Monitor" onClick="openInfo();">
</p>

<h3>Messages</h3>
<p>
send text: <input name="inputtext" type="text" size="30" maxlength="30" onkeyup="if (event.keyCode == 13) { sendText(); return false; }">
</p>
<p>
<textarea name="outputtext" rows="20" cols="50"></textarea>
</p>
<hr>
Notifications:<br>
<input type="checkbox" id="full" class="cb" onclick='handleClick(this);'><label for="full"> Full Pot</label><br>
<input type="checkbox" id="normal" class="cb" onclick='handleClick(this);'><label for="normal"> Normal Pot</label><br>
<input type="checkbox" id="empty" class="cb" onclick='handleClick(this);'><label for="empty"> Empty Pot</label><br>
<input type="checkbox" id="nopot" class="cb" onclick='handleClick(this);'><label for="nopot"> No Pot</label><br>
<input type="checkbox" id="join" class="cb" onclick='handleClick(this);'><label for="join"> Somebody joins the chat</label><br>
<input type="checkbox" id="leave" class="cb" onclick='handleClick(this);'><label for="leave"> Somebody leaves the chat</label><br>
<input type="checkbox" id="write" class="cb" onclick='handleClick(this);'><label for="write"> Somebody writes</label><br>

</form>
<hr>
<h3>Credits</h3>
The chat icons are
<a href='https://www.freepik.com/free-vector/social-media-flat-icon-set_841696.htm'>Designed by Freepik</a>
<br>
The original Coffee Maker symbol is <a href='https://thenounproject.com/inspign/'>(cc) by Aaron K. Kim from the Noun Project</a>
<br>Coffeemon itself is Open Source and <a href='https://github.com/stko/coffeemon'>hosted on Github<img src='GitHub-Mark-32px.png'></a>

</body>
</html> 


