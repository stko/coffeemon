
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<title>CoffeeMon</title>

<script language="javascript" type="text/javascript">
var lastEchoTime=0;

  function init()
  {
	document.myform.url.value = "wss://oobd.luxen.de/websockssl"
	if (localStorage && 'url' in localStorage) {
		document.myform.url.value = localStorage.url;
	}
	document.myform.keytext.value = ""
	if (localStorage && 'keytext' in localStorage) {
		document.myform.keytext.value = localStorage.keytext;
	}

	document.myform.inputtext.value = ""
	document.myform.connectButton.disabled=document.myform.keytext.value.length<4
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;
  }

  function doConnect()
  {
    websocket = new WebSocket(document.myform.url.value);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
	//doSend(JSON.stringify({msg:  btoa(document.myform.keytext.value+ " enters the coffee kitchen"), channel: btoa(document.myform.keytext.value)})  );
        localStorage && (localStorage.url = document.myform.url.value);
        localStorage && (localStorage.keytext = document.myform.keytext.value);

	writeToScreen("connected\n");
	document.myform.url.disabled = true;
	document.myform.keytext.disabled = true;
	document.myform.connectButton.disabled = true;
	document.myform.disconnectButton.disabled = false;
	document.myform.echoButton.disabled = false;
 	document.myform.inputtext.disabled = false;
 	
  }

  function onClose(evt)
  {
	writeToScreen("disconnected\n");
	document.myform.url.disabled = false;
	document.myform.keytext.disabled = false;
	document.myform.connectButton.disabled = false;
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;
   }

  function onMessage(evt)
  {
  console.log(evt);
  console.log(evt.data);
	try {
		obj = JSON.parse(evt.data);
		  console.log(evt.data);

		arrivingTime=Date.now();
		if (obj.value){
			writeToScreen(atob(obj.value));
		}
		if (obj.status){
			writeToScreen(atob(obj.status));
		}
		if (obj.msg){
			writeToScreen(document.myform.keytext.value+": "+atob(obj.msg));
		}
	}
	catch(err){
		console.log("Json Error "+err.message);
	}
  }

  function onError(evt)
  {
    writeToScreen('error: ' + evt.data + '\n');

	websocket.close();

	document.myform.url.disabled = false;
	document.myform.keytext.disabled = false;
	document.myform.connectButton.disabled = false;
	document.myform.disconnectButton.disabled = true;
	document.myform.echoButton.disabled = true;
 	document.myform.inputtext.disabled = true;

  }

  function doSend(message)
  {
    writeToScreen( message + '\n'); 
    websocket.send(message);
  }

  function writeToScreen(message)
  {
    document.myform.outputtext.value += message
	document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;

  }

  window.addEventListener("load", init, false);


   function sendText() {
		var msg=JSON.stringify({msg: btoa(document.myform.inputtext.value+"\r"), channel: btoa(document.myform.keytext.value)}); 
		doSend(msg  );
		writeToScreen(document.myform.inputtext.value+"\n");
   }

  function doEcho() {
		var msg=JSON.stringify({value: "", msg: "", channel: btoa(document.myform.keytext.value)}); 
		doSend(msg  );
   }

  function clearText() {
		document.myform.outputtext.value = "";
   }

   function doDisconnect() {
		doSend(JSON.stringify({msg:  btoa(document.myform.keytext.value+ " leaves the coffee kitchen"), channel: btoa(document.myform.keytext.value)})  );
		websocket.close();
   }


</script>

</head>
<body>
<h2>CoffeeMon - the Coffee Pot Status Monitor</h2>

Want to know the filling level of the office coffee pot?? Just connect to the Coffee Pot Status Monitor and be informed!<br>


<div id="output"></div>

<form name="myform">
<h3>Settings:</h3>

<p> Coffee Pot Status Monitor Server URL: 

<input name="url" type="text" size="30" maxlength="30"></p>

<p>
Chat nickname (min. 4 chars): <input name="keytext" type="text" value="aa" size="30" maxlength="140" onkeyup="document.myform.connectButton.disabled=this.value.length<4"></p>
<p>

<!--
<input type="button" name=sendButton value="Send" onClick="sendText();">
-->
<input type="button" name=connectButton value="Connect" onClick="doConnect();">
<input type="button" name=clearButton value="Clear" onClick="clearText();">
<input type="button" name=echoButton value="Read actual weight value" onClick="doEcho();">
<input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
</p>
<hr>

<h2>Output</h2>
<p>
<textarea name="outputtext" rows="20" cols="50"></textarea>
</p>
<p>
<!--
<textarea name="inputtext" cols="50"></textarea>
-->
<!--
Firmware command: <input name="inputtext" type="text" size="30" maxlength="30" onkeyup="if (event.keyCode == 13) { sendText(); document.myform.inputtext.value=''; return false; }">
-->
send text: <input name="inputtext" type="text" size="30" maxlength="30" onkeyup="if (event.keyCode == 13) { sendText(); return false; }">
</p>

</form>
</body>
</html> 

<!--

// request permission on page load
document.addEventListener('DOMContentLoaded', function () {
  if (!Notification) {
    alert('Desktop notifications not available in your browser. Try Chromium.'); 
    return;
  }

  if (Notification.permission !== "granted")
    Notification.requestPermission();
});

function notifyMe() {
  if (Notification.permission !== "granted")
    Notification.requestPermission();
  else {
    var notification = new Notification('Notification title', {
      icon: 'http://cdn.sstatic.net/stackexchange/img/logos/so/so-icon.png',
      body: "Hey there! You've been notified!",
    });

    notification.onclick = function () {
      window.open("http://stackoverflow.com/a/13328397/1269037");      
    };

  }

}
<button onclick="notifyMe()">Notify me!</button>


-->

